<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolbar Slot Switch Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #333;
            color: white;
        }
        .toolbar {
            display: flex;
            gap: 5px;
            margin: 20px 0;
        }
        .toolbar-slot {
            position: relative;
            width: 50px;
            height: 50px;
            border: 2px solid #666;
            background: #222;
        }
        .toolbar-slot img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .toolbar-slot.selected {
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .toolbar-quantity {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .log {
            background: #111;
            padding: 10px;
            margin-top: 20px;
            border: 1px solid #666;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4CAF50;
        }
        .log-entry.error {
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Toolbar Slot Switch Bug Test</h1>
    <p>This test simulates the bug where placing all items in a slot doesn't update the activeBlockId.</p>
    
    <div id="toolbar" class="toolbar">
        <div class="toolbar-slot">
            <img id="toolbar-0" src="textures/pickaxe.png" class="selected">
        </div>
        <div class="toolbar-slot">
            <img id="toolbar-1" style="opacity: 0.3">
        </div>
        <div class="toolbar-slot">
            <img id="toolbar-2" style="opacity: 0.3">
        </div>
        <div class="toolbar-slot">
            <img id="toolbar-3" style="opacity: 0.3">
        </div>
    </div>

    <div>
        <h3>Test Scenario:</h3>
        <button onclick="setupTest()">1. Setup Test (Add 1 Stone + 5 Dirt)</button>
        <button onclick="selectSlot1()">2. Select Slot 1 (Stone)</button>
        <button onclick="placeBlock()">3. Place Block (Should empty slot 1, show dirt)</button>
        <button onclick="placeBlock()">4. Try Place Again (Should work with dirt)</button>
    </div>

    <div>
        <p><strong>Current Active Block ID:</strong> <span id="activeBlockId">0</span></p>
        <p><strong>Expected Block ID:</strong> <span id="expectedBlockId">0</span></p>
        <p><strong>Status:</strong> <span id="status">Ready</span></p>
    </div>

    <div class="log" id="log"></div>

    <script type="module">
        import { InventoryManager } from './scripts/inventory/inventoryManager.js';
        import { ToolbarUI } from './scripts/inventory/ToolbarUI.js';

        // Mock player object
        const mockPlayer = {
            activeBlockId: 0,
            inventory: new InventoryManager(),
            tool: {
                container: {
                    visible: true
                }
            }
        };

        // Create toolbar UI
        const toolbarUI = new ToolbarUI(mockPlayer.inventory);
        toolbarUI.player = mockPlayer;

        // Logging function
        function log(message, isError = false) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isError ? ' error' : '');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateDisplay() {
            document.getElementById('activeBlockId').textContent = mockPlayer.activeBlockId;
        }

        window.setupTest = function() {
            // Clear inventory
            mockPlayer.inventory.clear();
            
            // Add 1 stone (blockId 3) and 5 dirt (blockId 2)
            mockPlayer.inventory.addItem(3, 1); // Stone
            mockPlayer.inventory.addItem(2, 5); // Dirt
            
            // Render toolbar
            toolbarUI.render();
            
            log('Setup complete: Added 1 Stone and 5 Dirt to inventory');
            log('Slot 1 should show Stone (1x), Slot 2 should show Dirt (5x)');
            document.getElementById('status').textContent = 'Test setup complete';
            document.getElementById('expectedBlockId').textContent = '0 (Pickaxe)';
            updateDisplay();
        };

        window.selectSlot1 = function() {
            // Simulate selecting slot 1
            document.getElementById('toolbar-0').classList.remove('selected');
            document.getElementById('toolbar-1').classList.add('selected');
            
            // Get the block ID from slot 1
            const slotContent = toolbarUI.slotContents.get(1);
            if (slotContent) {
                mockPlayer.activeBlockId = slotContent[0];
                mockPlayer.tool.container.visible = false;
                log(`Selected Slot 1: Block ID ${mockPlayer.activeBlockId} (Stone)`);
                document.getElementById('status').textContent = 'Slot 1 selected (Stone)';
                document.getElementById('expectedBlockId').textContent = '3 (Stone)';
            } else {
                log('ERROR: Slot 1 is empty!', true);
                document.getElementById('status').textContent = 'ERROR: Slot 1 empty';
            }
            updateDisplay();
        };

        window.placeBlock = function() {
            const blockId = mockPlayer.activeBlockId;
            
            if (blockId === 0) {
                log('ERROR: Cannot place with pickaxe (blockId 0)', true);
                document.getElementById('status').textContent = 'ERROR: Pickaxe selected';
                return;
            }

            // Check if player has the item
            if (!mockPlayer.inventory.hasItem(blockId)) {
                log(`ERROR: Cannot place block ${blockId} - not in inventory!`, true);
                document.getElementById('status').textContent = `ERROR: No block ${blockId} in inventory`;
                return;
            }

            // Remove item from inventory
            const removed = mockPlayer.inventory.removeItem(blockId, 1);
            
            if (removed) {
                log(`Placed block ${blockId}, removed from inventory`);
                
                // Render toolbar (this should update activeBlockId if slot changed)
                toolbarUI.render();
                
                // Check what's in slot 1 now
                const slotContent = toolbarUI.slotContents.get(1);
                if (slotContent) {
                    log(`Slot 1 now contains: Block ID ${slotContent[0]} (${slotContent[1]}x)`);
                    document.getElementById('expectedBlockId').textContent = `${slotContent[0]} (Dirt)`;
                } else {
                    log('Slot 1 is now empty');
                    document.getElementById('expectedBlockId').textContent = '0 (Pickaxe)';
                }
                
                log(`Player activeBlockId is now: ${mockPlayer.activeBlockId}`);
                
                // Verify the fix worked
                if (slotContent && mockPlayer.activeBlockId === slotContent[0]) {
                    log('✓ SUCCESS: activeBlockId correctly updated to match new slot content!');
                    document.getElementById('status').textContent = '✓ Fix working correctly!';
                } else if (!slotContent && mockPlayer.activeBlockId === 0) {
                    log('✓ SUCCESS: activeBlockId correctly switched to pickaxe (empty slot)!');
                    document.getElementById('status').textContent = '✓ Fix working correctly!';
                } else {
                    log('✗ FAIL: activeBlockId not updated correctly!', true);
                    document.getElementById('status').textContent = '✗ Bug still present!';
                }
                
                updateDisplay();
            } else {
                log('ERROR: Failed to remove item from inventory', true);
            }
        };

        // Make objects available globally for debugging
        window.mockPlayer = mockPlayer;
        window.toolbarUI = toolbarUI;
        
        log('Test page loaded. Click "Setup Test" to begin.');
    </script>
</body>
</html>
